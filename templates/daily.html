{% extends "base.html" %}

{% block title %}{{ date_display }} - Bibliaolvasási Terv{% endblock %}

{% block content %}
<div class="row">
    <!-- Fő tartalom -->
    <div class="col-lg-9">
        <!-- Navigáció és dátum -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                {% if prev_date %}
                <a href="{{ url_for('bible.daily', date_str=prev_date) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-chevron-left"></i> Előző
                </a>
                {% endif %}
            </div>
            
            <div class="text-center">
                <h2 class="mb-0">
                    <i class="bi bi-calendar-event text-primary"></i>
                    {{ date_display }}
                </h2>
                {% if date_str == today %}
                <span class="badge bg-success">Ma</span>
                {% endif %}
            </div>
            
            <div>
                {% if next_date %}
                <a href="{{ url_for('bible.daily', date_str=next_date) }}" class="btn btn-outline-secondary">
                    Következő <i class="bi bi-chevron-right"></i>
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Olvasási szakaszok -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h5 class="mb-0">
                    <i class="bi bi-book"></i> Mai olvasmányok
                    {% if readings %}
                    <span class="badge bg-light text-primary ms-2">{{ readings|length }} szakasz</span>
                    {% endif %}
                </h5>
                <!-- Fordítás választó -->
                <div class="translation-selector">
                    <label for="translationSelect" class="small text-white-50 mb-0">Fordítás:</label>
                    <select id="translationSelect" class="form-select form-select-sm">
                        <option value="SZIT">SZIT</option>
                        <option value="RUF">RUF</option>
                        <option value="KG">KG</option>
                        <option value="KNB">KNB</option>
                        <option value="UF">UF</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                {% if readings and readings|length > 0 %}
                    {% for section in readings %}
                    <div class="reading-section {{ 'mb-4' if not loop.last else 'mb-3' }}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi {{ section.icon }}"></i> {{ section.name }}</h6>
                            <button class="btn btn-sm btn-outline-primary toggle-text" data-target="section-{{ section.id }}-text">
                                <i class="bi bi-eye"></i> Szöveg
                            </button>
                        </div>
                        <p class="lead mb-2">{{ section.reference }}</p>
                        <div class="bible-text collapse show" id="section-{{ section.id }}-text">
                            <div class="bible-content p-3 bg-light rounded" 
                                 data-section="{{ section.id }}"
                                 data-reference="{{ section.reference }}">
                                <div class="verse-loading text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Betöltés...</span>
                                    </div>
                                    <span class="ms-2 text-muted">Szöveg betöltése...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">Erre a napra nincs olvasmány megadva.</p>
                {% endif %}
            </div>
            <div class="card-footer d-flex justify-content-between align-items-center flex-wrap gap-2">
                <button class="btn {{ 'btn-success' if is_read else 'btn-outline-success' }}" 
                        id="markReadBtn"
                        data-date="{{ date_str }}"
                        data-read="{{ 'true' if is_read else 'false' }}">
                    <i class="bi {{ 'bi-check-circle-fill' if is_read else 'bi-circle' }}"></i>
                    {{ 'Elolvasva ✓' if is_read else 'Megjelölés olvasottként' }}
                </button>
                
                <!-- Olvasók száma -->
                <div class="readers-info">
                    {% if readers_count > 0 %}
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#readersList" aria-expanded="false">
                        <i class="bi bi-people-fill"></i>
                        <span class="readers-count">{{ readers_count }}</span> {{ 'személy' if readers_count == 1 else 'személy' }} olvasta el
                    </button>
                    {% else %}
                    <span class="text-muted small">
                        <i class="bi bi-people"></i> Még senki nem olvasta el
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Olvasók listája -->
            {% if readers_count > 0 %}
            <div class="collapse" id="readersList">
                <div class="card-footer bg-light border-top-0">
                    <small class="text-muted d-block mb-2"><i class="bi bi-check2-all"></i> Elolvasták:</small>
                    <div class="d-flex flex-wrap gap-2">
                        {% for reader in readers %}
                        <span class="badge bg-success-subtle text-success-emphasis">
                            <i class="bi bi-person-check"></i> {{ reader.name }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Kiemelések -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="bi bi-highlighter"></i> Kiemelések
                    <small class="ms-2 fw-normal">(Jelölj ki szöveget a Bibliából!)</small>
                </h5>
            </div>
            <div class="card-body">
                <!-- Kézi kiemelés form - összecsukható -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#manualHighlightForm">
                        <i class="bi bi-pencil"></i> Kézi kiemelés hozzáadása
                    </button>
                </div>
                <form id="highlightForm" class="collapse mb-3" id="manualHighlightForm">
                    <div class="row g-2">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="highlightVerse" 
                                   placeholder="Vers (pl. Jn 3:16)">
                        </div>
                        <div class="col-md-7">
                            <input type="text" class="form-control" id="highlightText" 
                                   placeholder="Kiemelt szöveg..." required>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-warning w-100">
                                <i class="bi bi-plus"></i> Hozzáad
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Kiemelések listája -->
                <div id="highlightsList">
                    {% for highlight in highlights %}
                    <div class="highlight-item p-2 mb-2 rounded {% if highlight.user_id == session.user_id %}own-highlight{% endif %}" 
                         style="background-color: rgba(255, 193, 7, 0.2);"
                         data-id="{{ highlight.id }}"
                         data-ref="{{ highlight.verse_ref }}"
                         {% if highlight.user_id == session.user_id %}data-own="true"{% endif %}
                         onclick="scrollToHighlightedVerse({{ highlight.verse_ref | tojson }})">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                {% if highlight.verse_ref %}
                                <strong class="text-primary">{{ highlight.verse_ref }}:</strong>
                                {% endif %}
                                <span>"{{ highlight.text }}"</span>
                                <br>
                                <small class="text-muted">
                                    <i class="bi bi-person"></i> {{ highlight.user_name }}
                                </small>
                            </div>
                            {% if highlight.user_id == session.user_id %}
                            <button class="btn btn-sm btn-outline-danger delete-highlight" 
                                    data-id="{{ highlight.id }}"
                                    onclick="event.stopPropagation();">
                                <i class="bi bi-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0" id="noHighlights">Még nincsenek kiemelések.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Kommentek -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-chat-dots"></i> Gondolatok és megjegyzések
                </h5>
            </div>
            <div class="card-body">
                <!-- Új komment form -->
                <form id="commentForm" class="mb-4">
                    <div class="mb-2">
                        <input type="text" class="form-control" id="commentVerse" 
                               placeholder="Vers hivatkozás (opcionális, pl. Mt 5:3-12)">
                    </div>
                    <div class="mb-2">
                        <textarea class="form-control" id="commentContent" rows="3" 
                                  placeholder="Írd le a gondolataidat..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-info text-white">
                        <i class="bi bi-send"></i> Küldés
                    </button>
                </form>

                <!-- Kommentek listája -->
                <div id="commentsList">
                    {% for comment in comments %}
                    <div class="comment-item p-3 mb-3 border rounded" data-id="{{ comment.id }}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong class="text-primary">
                                    <i class="bi bi-person-circle"></i> {{ comment.user_name }}
                                </strong>
                                {% if comment.verse_ref %}
                                <span class="badge bg-secondary ms-2">{{ comment.verse_ref }}</span>
                                {% endif %}
                            </div>
                            <div>
                                <small class="text-muted">{{ comment.created_at }}</small>
                                {% if comment.user_id == session.user_id %}
                                <button class="btn btn-sm btn-outline-primary ms-2 edit-comment" 
                                        data-id="{{ comment.id }}"
                                        data-content="{{ comment.content }}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-comment" 
                                        data-id="{{ comment.id }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <p class="mb-0 comment-content">{{ comment.content }}</p>
                        <!-- Szerkesztő űrlap (alapból rejtett) -->
                        <div class="edit-form d-none mt-2">
                            <textarea class="form-control mb-2 edit-textarea" rows="3">{{ comment.content }}</textarea>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-success save-edit" data-id="{{ comment.id }}">
                                    <i class="bi bi-check"></i> Mentés
                                </button>
                                <button class="btn btn-sm btn-outline-secondary cancel-edit">
                                    <i class="bi bi-x"></i> Mégse
                                </button>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0" id="noComments">
                        Még nincsenek gondolatok megosztva. Légy te az első!
                    </p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Oldalsáv -->
    <div class="col-lg-3">
        <!-- Ugrás napra -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-calendar"></i> Ugrás napra</h6>
            </div>
            <div class="card-body">
                <form id="jumpToDateForm">
                    <div class="input-group">
                        <select class="form-select" id="jumpMonth">
                            <option value="01">Január</option>
                            <option value="02">Február</option>
                            <option value="03">Március</option>
                            <option value="04">Április</option>
                            <option value="05">Május</option>
                            <option value="06">Június</option>
                            <option value="07">Július</option>
                            <option value="08">Augusztus</option>
                            <option value="09">Szeptember</option>
                            <option value="10">Október</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                        <select class="form-select" id="jumpDay">
                            {% for d in range(1, 32) %}
                            <option value="{{ '%02d' % d }}">{{ d }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </form>
                <div class="mt-2">
                    <a href="{{ url_for('bible.daily') }}" class="btn btn-sm btn-outline-primary w-100">
                        <i class="bi bi-calendar-day"></i> Mai nap
                    </a>
                </div>
            </div>
        </div>

        <!-- Felhasználóváltás -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-people"></i> Felhasználóváltás</h6>
            </div>
            <div class="card-body">
                <form action="{{ url_for('auth.switch_user') }}" method="POST">
                    <div class="input-group">
                        <select class="form-select" name="username">
                            {% for user in users %}
                            <option value="{{ user.name }}" 
                                    {{ 'selected' if user.id == session.user_id else '' }}>
                                {{ user.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-secondary">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                    </div>
                </form>
                <small class="text-muted">
                    Vagy <a href="{{ url_for('auth.logout') }}">jelentkezz ki</a> új névvel.
                </small>
            </div>
        </div>

        <!-- Gyors statisztika -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Naptár</h6>
            </div>
            <div class="card-body text-center">
                <a href="{{ url_for('bible.calendar') }}" class="btn btn-outline-primary">
                    <i class="bi bi-calendar3"></i> Éves áttekintés
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // Aktuális dátum beállítása a jump formban
    const currentDate = "{{ date_str }}";
    if (currentDate) {
        const [month, day] = currentDate.split('-');
        document.getElementById('jumpMonth').value = month;
        document.getElementById('jumpDay').value = day;
    }
</script>

<!-- Lebegő kiemelés panel - fix pozícióban a képernyő alján -->
<div id="selectionHighlight" class="selection-highlight-floating d-none">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center gap-3">
            <div class="flex-grow-1 overflow-hidden">
                <strong id="selectedVerseRef" class="text-primary"></strong>
                <span id="selectedText" class="fst-italic text-truncate d-block"></span>
            </div>
            <div class="d-flex gap-2 flex-shrink-0">
                <button type="button" class="btn btn-warning" id="confirmHighlight">
                    <i class="bi bi-highlighter"></i> <span class="d-none d-sm-inline">Mentés</span>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="cancelHighlight">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

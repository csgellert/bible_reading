{% extends "base.html" %}

{% block title %}{{ date_display }} - Bibliaolvasási Terv{% endblock %}

{% block content %}
<div class="row">
    <!-- Fő tartalom -->
    <div class="col-lg-9">
        <!-- Navigáció és dátum -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                {% if prev_date %}
                <a href="{{ url_for('bible.daily', date_str=prev_date) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-chevron-left"></i> Előző
                </a>
                {% endif %}
            </div>
            
            <div class="text-center">
                <h2 class="mb-0">
                    <i class="bi bi-calendar-event text-primary"></i>
                    {{ date_display }}
                </h2>
                {% if date_str == today %}
                <span class="badge bg-success">Ma</span>
                {% endif %}
                {% if epoch %}
                <div class="epoch-badge mt-2">
                    <span class="badge px-3 py-2" style="background-color: {{ epoch.bg }}; color: {{ epoch.color }}; border: 2px solid {{ epoch.color }}; font-size: 0.9rem;">
                        <i class="bi bi-clock-history me-1"></i> {{ epoch.name }}
                    </span>
                </div>
                {% endif %}
            </div>
            
            <div>
                {% if next_date %}
                <a href="{{ url_for('bible.daily', date_str=next_date) }}" class="btn btn-outline-secondary">
                    Következő <i class="bi bi-chevron-right"></i>
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Olvasási szakaszok -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h5 class="mb-0">
                    <i class="bi bi-book"></i> Mai olvasmányok
                    {% if readings %}
                    <span class="badge bg-light text-primary ms-2">{{ readings|length }} szakasz</span>
                    {% endif %}
                </h5>
                <!-- Fordítás választó -->
                <div class="translation-selector">
                    <label for="translationSelect" class="small text-white-50 mb-0">Fordítás:</label>
                    <select id="translationSelect" class="form-select form-select-sm">
                        <option value="SZIT">SZIT</option>
                        <option value="RUF">RUF</option>
                        <option value="KG">KG</option>
                        <option value="KNB">KNB</option>
                        <option value="UF">UF</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                {% if readings and readings|length > 0 %}
                    {% for section in readings %}
                    <div class="reading-section {{ 'mb-4' if not loop.last else 'mb-3' }}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi {{ section.icon }}"></i> {{ section.name }}</h6>
                            <button class="btn btn-sm btn-outline-primary toggle-text" data-target="section-{{ section.id }}-text">
                                <i class="bi bi-eye"></i> Szöveg
                            </button>
                        </div>
                        <p class="lead mb-2">{{ section.reference }}</p>
                        <div class="bible-text collapse show" id="section-{{ section.id }}-text">
                            <div class="bible-content p-3 bg-light rounded" 
                                 data-section="{{ section.id }}"
                                 data-reference="{{ section.reference }}">
                                <div class="verse-loading text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Betöltés...</span>
                                    </div>
                                    <span class="ms-2 text-muted">Szöveg betöltése...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">Erre a napra nincs olvasmány megadva.</p>
                {% endif %}
            </div>
            <div class="card-footer d-flex justify-content-between align-items-center flex-wrap gap-2">
                <button class="btn {{ 'btn-success' if is_read else 'btn-outline-success' }}" 
                        id="markReadBtn"
                        data-date="{{ date_str }}"
                        data-read="{{ 'true' if is_read else 'false' }}">
                    <i class="bi {{ 'bi-check-circle-fill' if is_read else 'bi-circle' }}"></i>
                    {{ 'Elolvasva ✓' if is_read else 'Megjelölés olvasottként' }}
                </button>
                
                <!-- Olvasók száma -->
                <div class="readers-info">
                    {% if readers_count > 0 %}
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#readersList" aria-expanded="false">
                        <i class="bi bi-people-fill"></i>
                        <span class="readers-count">{{ readers_count }}</span> {{ 'személy' if readers_count == 1 else 'személy' }} olvasta el
                    </button>
                    {% else %}
                    <span class="text-muted small">
                        <i class="bi bi-people"></i> Még senki nem olvasta el
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Olvasók listája -->
            {% if readers_count > 0 %}
            <div class="collapse" id="readersList">
                <div class="card-footer bg-light border-top-0">
                    <small class="text-muted d-block mb-2"><i class="bi bi-check2-all"></i> Elolvasták:</small>
                    <div class="d-flex flex-wrap gap-2">
                        {% for reader in readers %}
                        <span class="badge bg-success-subtle text-success-emphasis">
                            <i class="bi bi-person-check"></i> {{ reader.name }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Kiemelések -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="bi bi-highlighter"></i> Kiemelések
                    <small class="ms-2 fw-normal">(Jelölj ki szöveget a Bibliából!)</small>
                </h5>
            </div>
            <div class="card-body">
                <!-- Kézi kiemelés form - összecsukható -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#manualHighlightForm">
                        <i class="bi bi-pencil"></i> Kézi kiemelés hozzáadása
                    </button>
                </div>
                <form id="highlightForm" class="collapse mb-3" id="manualHighlightForm">
                    <div class="row g-2">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="highlightVerse" 
                                   placeholder="Vers (pl. Jn 3:16)">
                        </div>
                        <div class="col-md-7">
                            <input type="text" class="form-control" id="highlightText" 
                                   placeholder="Kiemelt szöveg..." required>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-warning w-100">
                                <i class="bi bi-plus"></i> Hozzáad
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Kiemelések listája -->
                <div id="highlightsList">
                    {% for highlight in highlights %}
                    <div class="highlight-item p-2 mb-2 rounded {% if highlight.user_id == session.user_id %}own-highlight{% endif %}" 
                         style="background-color: rgba(255, 193, 7, 0.2);"
                         data-id="{{ highlight.id }}"
                         data-ref="{{ highlight.verse_ref }}"
                         {% if highlight.user_id == session.user_id %}data-own="true"{% endif %}>
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1" onclick="scrollToHighlightedVerse(this.closest('.highlight-item').dataset.ref)" style="cursor: pointer;">
                                {% if highlight.verse_ref %}
                                <strong class="text-primary">{{ highlight.verse_ref }}:</strong>
                                {% endif %}
                                <span>"{{ highlight.text }}"</span>
                                <br>
                                <small class="text-muted">
                                    <i class="bi bi-person"></i> {{ highlight.user_name }}
                                    {% if highlight.is_private %}
                                    <i class="bi bi-lock-fill text-secondary ms-1" title="Privát"></i>
                                    {% endif %}
                                </small>
                            </div>
                            <div class="d-flex align-items-center gap-1">
                                <!-- Like gomb -->
                                {% if highlight.user_id != session.user_id %}
                                <button class="btn btn-sm {% if highlight.user_reacted %}btn-danger{% else %}btn-outline-danger{% endif %} reaction-btn" 
                                        data-type="highlight" data-id="{{ highlight.id }}"
                                        onclick="event.stopPropagation(); toggleReaction('highlight', {{ highlight.id }}, this);">
                                    <i class="bi bi-heart{% if highlight.user_reacted %}-fill{% endif %}"></i>
                                    <span class="reaction-count">{{ highlight.reaction_count or '' }}</span>
                                </button>
                                {% else %}
                                <!-- Reakciók számának megjelenítése a saját kiemeléseken -->
                                {% if highlight.reaction_count > 0 %}
                                <span class="badge bg-danger-subtle text-danger">
                                    <i class="bi bi-heart-fill"></i> {{ highlight.reaction_count }}
                                </span>
                                {% endif %}
                                <!-- Privát toggle -->
                                <button class="btn btn-sm btn-outline-secondary privacy-btn" 
                                        data-type="highlight" data-id="{{ highlight.id }}"
                                        data-private="{{ 'true' if highlight.is_private else 'false' }}"
                                        onclick="event.stopPropagation(); togglePrivacy('highlight', {{ highlight.id }}, this);"
                                        title="{% if highlight.is_private %}Nyilvánossá tétel{% else %}Priváttá tétel{% endif %}">
                                    <i class="bi bi-{% if highlight.is_private %}lock-fill{% else %}unlock{% endif %}"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-highlight" 
                                        data-id="{{ highlight.id }}"
                                        onclick="event.stopPropagation();">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0" id="noHighlights">Még nincsenek kiemelések.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Kommentek -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-chat-dots"></i> Gondolatok és megjegyzések
                </h5>
            </div>
            <div class="card-body">
                <!-- Új komment form -->
                <form id="commentForm" class="mb-4">
                    <div class="mb-2">
                        <input type="text" class="form-control" id="commentVerse" 
                               placeholder="Vers hivatkozás (opcionális, pl. Mt 5:3-12)">
                    </div>
                    <div class="mb-2">
                        <textarea class="form-control" id="commentContent" rows="3" 
                                  placeholder="Írd le a gondolataidat..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-info text-white">
                        <i class="bi bi-send"></i> Küldés
                    </button>
                </form>

                <!-- Kommentek listája -->
                <div id="commentsList">
                    {% for comment in comments %}
                    <div class="comment-item p-3 mb-3 border rounded" data-id="{{ comment.id }}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong class="text-primary">
                                    <i class="bi bi-person-circle"></i> {{ comment.user_name }}
                                </strong>
                                {% if comment.verse_ref %}
                                <span class="badge bg-secondary ms-2">{{ comment.verse_ref }}</span>
                                {% endif %}
                                {% if comment.is_private %}
                                <i class="bi bi-lock-fill text-secondary ms-1" title="Privát"></i>
                                {% endif %}
                            </div>
                            <div class="d-flex align-items-center gap-1">
                                <small class="text-muted me-2">
                                    {{ comment.created_at|datetime_short }}
                                </small>
                                {% if comment.user_id == session.user_id %}
                                <!-- Privát toggle -->
                                <button class="btn btn-sm btn-outline-secondary privacy-btn" 
                                        data-type="comment" data-id="{{ comment.id }}"
                                        data-private="{{ 'true' if comment.is_private else 'false' }}"
                                        onclick="togglePrivacy('comment', {{ comment.id }}, this);"
                                        title="{% if comment.is_private %}Nyilvánossá tétel{% else %}Priváttá tétel{% endif %}">
                                    <i class="bi bi-{% if comment.is_private %}lock-fill{% else %}unlock{% endif %}"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary edit-comment" 
                                        data-id="{{ comment.id }}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-comment" 
                                        data-id="{{ comment.id }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <p class="mb-2 comment-content">{{ comment.content }}</p>
                        
                        <!-- Reakciók és válasz gomb -->
                        <div class="d-flex align-items-center gap-2 mb-2">
                            {% if comment.user_id != session.user_id %}
                            <button class="btn btn-sm {% if comment.user_reacted %}btn-danger{% else %}btn-outline-danger{% endif %} reaction-btn" 
                                    data-type="comment" data-id="{{ comment.id }}"
                                    onclick="toggleReaction('comment', {{ comment.id }}, this);">
                                <i class="bi bi-heart{% if comment.user_reacted %}-fill{% endif %}"></i>
                                <span class="reaction-count">{{ comment.reaction_count or '' }}</span>
                            </button>
                            {% else %}
                            {% if comment.reaction_count > 0 %}
                            <span class="badge bg-danger-subtle text-danger">
                                <i class="bi bi-heart-fill"></i> {{ comment.reaction_count }}
                            </span>
                            {% endif %}
                            {% endif %}
                            <button class="btn btn-sm btn-outline-secondary reply-toggle-btn" 
                                    onclick="toggleReplyForm({{ comment.id }});">
                                <i class="bi bi-chat-left"></i> Válasz
                                {% if comment.replies|length > 0 %}
                                <span class="badge bg-secondary">{{ comment.replies|length }}</span>
                                {% endif %}
                            </button>
                        </div>
                        
                        <!-- Válaszok megjelenítése -->
                        {% if comment.replies|length > 0 %}
                        <div class="replies-container ms-4 border-start ps-3">
                            {% for reply in comment.replies %}
                            <div class="reply-item small mb-2 p-2 bg-light rounded" data-reply-id="{{ reply.id }}">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <strong class="text-primary">{{ reply.user_name }}</strong>
                                        <span class="text-muted ms-2">
                                            {{ reply.created_at|datetime_short }}
                                        </span>
                                    </div>
                                    {% if reply.user_id == session.user_id %}
                                    <button class="btn btn-sm btn-outline-danger py-0 px-1" 
                                            onclick="deleteReply({{ reply.id }}, this);">
                                        <i class="bi bi-x"></i>
                                    </button>
                                    {% endif %}
                                </div>
                                <p class="mb-0 mt-1">{{ reply.content }}</p>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- Válasz űrlap (rejtett) -->
                        <div class="reply-form d-none ms-4 mt-2" id="reply-form-{{ comment.id }}">
                            <div class="input-group">
                                <input type="text" class="form-control form-control-sm reply-input" 
                                       placeholder="Írd ide a válaszod..." 
                                       onkeypress="if(event.key==='Enter') submitReply({{ comment.id }}, this);">
                                <button class="btn btn-sm btn-info text-white" 
                                        onclick="submitReply({{ comment.id }}, this.previousElementSibling);">
                                    <i class="bi bi-send"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Szerkesztő űrlap (alapból rejtett) -->
                        <div class="edit-form d-none mt-2">
                            <textarea class="form-control mb-2 edit-textarea" rows="3">{{ comment.content }}</textarea>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-success save-edit" data-id="{{ comment.id }}">
                                    <i class="bi bi-check"></i> Mentés
                                </button>
                                <button class="btn btn-sm btn-outline-secondary cancel-edit">
                                    <i class="bi bi-x"></i> Mégse
                                </button>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0" id="noComments">
                        Még nincsenek gondolatok megosztva. Légy te az első!
                    </p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Oldalsáv -->
    <div class="col-lg-3">
        <!-- Ugrás napra -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-calendar"></i> Ugrás napra</h6>
            </div>
            <div class="card-body">
                <form id="jumpToDateForm">
                    <div class="mb-2">
                        {% if date_str and date_str|length >= 10 and date_str[:4].isdigit() %}
                            {% set current_year = date_str[:4]|int %}
                        {% else %}
                            {% set current_year = 2025 %}
                        {% endif %}
                        <select class="form-select form-select-sm" id="jumpYear">
                            {% for y in range(current_year - 2, current_year + 3) %}
                            <option value="{{ y }}" {{ 'selected' if y == current_year else '' }}>{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% if date_str and date_str|length >= 10 %}
                        {% set current_month = date_str[5:7] %}
                        {% set current_day = date_str[8:10] %}
                    {% else %}
                        {% set current_month = '01' %}
                        {% set current_day = '01' %}
                    {% endif %}
                    <div class="input-group">
                        <select class="form-select" id="jumpMonth">
                            <option value="01" {{ 'selected' if current_month == '01' else '' }}>Január</option>
                            <option value="02" {{ 'selected' if current_month == '02' else '' }}>Február</option>
                            <option value="03" {{ 'selected' if current_month == '03' else '' }}>Március</option>
                            <option value="04" {{ 'selected' if current_month == '04' else '' }}>Április</option>
                            <option value="05" {{ 'selected' if current_month == '05' else '' }}>Május</option>
                            <option value="06" {{ 'selected' if current_month == '06' else '' }}>Június</option>
                            <option value="07" {{ 'selected' if current_month == '07' else '' }}>Július</option>
                            <option value="08" {{ 'selected' if current_month == '08' else '' }}>Augusztus</option>
                            <option value="09" {{ 'selected' if current_month == '09' else '' }}>Szeptember</option>
                            <option value="10" {{ 'selected' if current_month == '10' else '' }}>Október</option>
                            <option value="11" {{ 'selected' if current_month == '11' else '' }}>November</option>
                            <option value="12" {{ 'selected' if current_month == '12' else '' }}>December</option>
                        </select>
                        <select class="form-select" id="jumpDay">
                            {% for d in range(1, 32) %}
                            <option value="{{ '%02d' % d }}" {{ 'selected' if '%02d' % d == current_day else '' }}>{{ d }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </form>
                <div class="mt-2">
                    <a href="{{ url_for('bible.daily') }}" class="btn btn-sm btn-outline-primary w-100">
                        <i class="bi bi-calendar-day"></i> Mai nap
                    </a>
                </div>
            </div>
        </div>

        <!-- Gyors statisztika -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Naptár</h6>
            </div>
            <div class="card-body text-center">
                <a href="{{ url_for('bible.calendar') }}" class="btn btn-outline-primary">
                    <i class="bi bi-calendar3"></i> Éves áttekintés
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // Aktuális dátum beállítása a jump formban
    const currentDate = "{{ date_str }}";
    if (currentDate) {
        const [month, day] = currentDate.split('-');
        document.getElementById('jumpMonth').value = month;
        document.getElementById('jumpDay').value = day;
    }
</script>

<!-- Lebegő kiemelés panel - fix pozícióban a képernyő alján -->
<div id="selectionHighlight" class="selection-highlight-floating d-none">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center gap-3">
            <div class="flex-grow-1 overflow-hidden">
                <strong id="selectedVerseRef" class="text-primary"></strong>
                <span id="selectedText" class="fst-italic text-truncate d-block"></span>
            </div>
            <div class="d-flex gap-2 flex-shrink-0">
                <button type="button" class="btn btn-warning" id="confirmHighlight">
                    <i class="bi bi-highlighter"></i> <span class="d-none d-sm-inline">Mentés</span>
                </button>
                <button type="button" class="btn btn-outline-secondary" id="cancelHighlight">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
